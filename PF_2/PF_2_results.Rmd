---
title: "PF_2_answers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(mosaic)
library(readxl)
library(gmodels)
```

```{r, include=FALSE}
plot_histogram <- function(df, feature) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)))) +
    geom_histogram(aes(y = ..density..), alpha=0.7,binwidth=1, fill="#33AADE", color="black") +
    geom_density(alpha=0.3, fill="red") +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    print(plt)
}
plot_multi_histogram <- function(df, feature, label_column) {
    plt <- ggplot(df, aes(x=eval(parse(text=feature)), fill=eval(parse(text=label_column)))) +
    geom_histogram(alpha=0.7, position="identity", binwidth=1,aes(y = ..density..), color="black") +
    geom_density(alpha=0.7) +
    geom_vline(aes(xintercept=mean(eval(parse(text=feature)))), color="black", linetype="dashed", size=1) +
    labs(x=feature, y = "Density")
    plt + guides(fill=guide_legend(title=label_column))
}
```


```{r}
data_ex1 <- read_excel("data/Trips2020.xlsx")
head(data_ex1)
```
## Descriptive statistics

Analyse the data using descriptive statistics, e.g. summary statistics and a correlation matrix. What is the average number of trips using Trips and Trips1? Also plot the distribution of trips using the Trips1 variable. Comment your results.

```{r}
fav_df <- rbind(
  favstats(data_ex1$Income),
  favstats(data_ex1$Cars),
  favstats(data_ex1$Age),
  favstats(data_ex1$Male),
  favstats(data_ex1$Trips),
  favstats(data_ex1$Trips1)
)
row.names(fav_df) <- c("Income", "Cars", "Age", "Male", "Trips", "Trips1")
fav_df  %>% mutate(across(where(is.numeric), ~ round(., 4)))
```

```{r}
cor(data_ex1)
```

```{r}
plot_histogram(data_ex1, "Trips")
```
Assume you have estimated a Poisson model with the number of trips as dependent variable based on Trips1 with the following specification for the expected number of tours:

#add table

What can you say about the results and what is the expected number of trips for your sample according to the model? In addition, try to analyse the expected number of individuals with 0,1,2,3,4,5+ trips based on your model. Finally, use your estimated model to simulate the effect from a 20% increase in income on the number of trips. You can use either the income elasticity or simulation (the latter is similar to what you have to do for the logit model in step 5).

```{r}
data_ex1$poisson_results <- exp((1.001 + 0.058*log(data_ex1$Income + 1) + 0.043*data_ex1$Cars + -0.005*data_ex1$Age + -0.099*data_ex1$Male))
plot_histogram(data_ex1, "poisson_results")
```

```{r}
df <- data.frame("Trips"=c(data_ex1$poisson_results, data_ex1$Trips), "method"=rep(c("poisson model","empirical"), times=c(1000,1000)))
plot_multi_histogram(df, "Trips", "method")
```






```{r}
data_ex1$poisson_results <- exp((1.001 + 0.058*log(data_ex1$Income + 1) + 0.043*data_ex1$Cars + -0.005*data_ex1$Age + -0.099*data_ex1$Male))
mean(data_ex1$poisson_results)
```


```{r}
number_of_people <- c(
  dpois(0, mean(data_ex1$poisson_results), log = FALSE) * 1000,
  dpois(1, mean(data_ex1$poisson_results), log = FALSE) * 1000,
  dpois(2, mean(data_ex1$poisson_results), log = FALSE) * 1000,
  dpois(3, mean(data_ex1$poisson_results), log = FALSE) * 1000,
  dpois(4, mean(data_ex1$poisson_results), log = FALSE) * 1000,
  ppois(4, mean(data_ex1$poisson_results), log = FALSE, lower.tail=FALSE) * 1000)
number_of_people
```
```{r}
sum(number_of_people)
```
Elasticity of income with regards to trips is the beta-coefficient, because it is a log-log model

```{r}
20*0.058
```

```{r}
data_ex1$poisson_results_increased_income <- exp((1.001 + 0.058*log(data_ex1$Income *1.20 + 1) + 0.043*data_ex1$Cars + -0.005*data_ex1$Age + -0.099*data_ex1$Male))
mean(data_ex1$poisson_results_increased_income)/mean(data_ex1$poisson_results)
```
Specify a trip generation model based on cross-classification where you use at least two of the four variables in the Trips2020 data. You can use the quartiles of income to divide income in four intervals. Use the data to determine rates for different groups of individuals and use these rates when income is increased by 20% in a scenario. Discuss the difference between the cross-classification results and the results of the Poisson model.


```{r}
data_ex1$Income_group = 0
data_ex1$Age_group = 0
data_ex1$Cars_truncated <- data_ex1$Cars
data_ex1$Income_group[data_ex1$Income <= 100] <-  1
data_ex1$Income_group[data_ex1$Income > 100 & data_ex1$Income <= 220] <-  2
data_ex1$Income_group[data_ex1$Income > 220 & data_ex1$Income <= 350] <- 3
data_ex1$Income_group[data_ex1$Income > 350] <- 4
data_ex1$Age_group[data_ex1$Age <= 27.75] <- 1
data_ex1$Age_group[data_ex1$Age > 27.75 & data_ex1$Age <= 44] <- 2
data_ex1$Age_group[data_ex1$Age > 44 & data_ex1$Age <= 61] <- 3
data_ex1$Age_group[data_ex1$Age > 61] <- 4
data_ex1$Cars_truncated[data_ex1$Cars > 2] <- 2
```

```{r}
head(data_ex1)
```


```{r}
cross_classification <- data_ex1%>%
  group_by(Income_group, Age_group, Cars_truncated) %>%
  summarise(Trips = sum(Trips1), n=n(), avg_trips=Trips/n)
cross_classification
```
n is too small for some groups. So we try to remove the age group variable.

```{r}
cross_classification <- data_ex1%>%
  group_by(Income_group, Cars_truncated) %>%
  summarise(Trips = sum(Trips1), n=n(), avg_trips=Trips/n)
cross_classification
```


```{r}
data_ex1_sc <- data_ex1
data_ex1_sc$Income <- data_ex1_sc$Income*1.20

data_ex1_sc$Income_group[data_ex1_sc$Income <= 100] <-  1
data_ex1_sc$Income_group[data_ex1_sc$Income > 100 & data_ex1_sc$Income <= 220] <-  2
data_ex1_sc$Income_group[data_ex1_sc$Income > 220 & data_ex1_sc$Income <= 350] <- 3
data_ex1_sc$Income_group[data_ex1_sc$Income > 350] <- 4
```



```{r}
summary_sc <- data_ex1_sc %>%
  group_by(Income_group, Cars_truncated) %>%
  summarise(Trips = sum(Trips1), n=n(), avg_trips=Trips/n)
summary_sc
```

```{r}
cross_classification_2 <- subset(summary_sc, select=-avg_trips)
cross_classification_2$Cross_classification_trips <- summary_sc$n * cross_classification$avg_trips
cross_classification_2$Cross_classification <- cross_classification$avg_trips
cross_classification_2$n <- summary_sc$n
cross_classification_2$Income_group <- summary_sc$Income_group
cross_classification_2$Cars_truncated <- summary_sc$Cars_truncated
cross_classification_2$error <- cross_classification_2$Trips-cross_classification_2$Cross_classification_trips
cross_classification_2
```
We can calculate the error-terms MSE, MAD and MAPE.

```{r}
MSE = mean(cross_classification_2$error^2)
MAD = mean(abs(cross_classification_2$error))
MAPE = mean(abs(cross_classification_2$error/cross_classification_2$Trips) * 100)
evaluation <- data.frame(MSE,MAD,MAPE)
evaluation
```

