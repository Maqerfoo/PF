---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readxl)
library(tidyverse)
library(mosaic)
```

```{r}
df <- read_xlsx('data/labtown_2020data.xlsx')
od <- read_xlsx('data/labtown_od.xlsx')
```
```{r}
datalist = list()
for (x in colnames(df))
{
fav <- favstats(df[[x]])
datalist[[x]] <- fav
}
fav_df <- do.call(rbind, datalist)
fav_df <- fav_df %>% round()
fav_df
```

Conditional utilities, all conditioned on destination
```{r}
df$v_walk <- 1.49936144786925 - 0.12*60*(df$Dist/6) #6km/h 
df$v_bike <- 2.00813319212073 - 0.12*60*(df$Dist/12) #12km/h
df$v_car <- 0.493233143126145 - 0.05*df$cc - 0.06*df$ct + 1*df$CarStat
df$v_carp <- -0.684616198063556 - 0.1*df$ct
df$v_pub <- 0.220200561302239 - 0.05*df$pc - 0.05*df$pt - 0.03*df$ae
```


And then we calculate probabilities
```{r}
datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  logsum_mode <- log(exp(df_tmp$v_walk) + exp(df_tmp$v_bike) + exp(df_tmp$v_car) + exp(df_tmp$v_carp) + exp(df_tmp$v_pub))
  df_tmp$prob_walk <- exp(df_tmp$v_walk) / exp(logsum_mode)
  df_tmp$prob_bike <- exp(df_tmp$v_bike) / exp(logsum_mode)
  df_tmp$prob_car <- exp(df_tmp$v_car) / exp(logsum_mode)
  df_tmp$prob_carp <- exp(df_tmp$v_carp) / exp(logsum_mode)
  df_tmp$prob_pub <- exp(df_tmp$v_pub) / exp(logsum_mode)
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)
```

Check that every row sums to 1
```{r}
mean(df$prob_walk + df$prob_bike + df$prob_car + df$prob_carp + df$prob_pub)
```

And the utility of choosing a destination
```{r}
df$v_dest <- 1*log(df$EmpDest + 0.15*df$PopDest)
```

And the probability of choosing a destination
```{r}
datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  logsum_mode <- log(exp(df_tmp$v_walk) + exp(df_tmp$v_bike) + exp(df_tmp$v_car) + exp(df_tmp$v_carp) + exp(df_tmp$v_pub))
  df_tmp$prob_dest <- exp(df_tmp$v_dest + 0.7*logsum_mode) / sum(exp(df_tmp$v_dest + 0.7*logsum_mode))
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)
```


This should sum to 20
```{r}
sum(df$prob_dest)
```
The joint probabilities are given as
```{r}
datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  df_tmp$jointprob_walk <- df_tmp$prob_walk * df_tmp$prob_dest 
  df_tmp$jointprob_bike <- df_tmp$prob_bike * df_tmp$prob_dest 
  df_tmp$jointprob_car <- df_tmp$prob_car * df_tmp$prob_dest 
  df_tmp$jointprob_carp <- df_tmp$prob_carp * df_tmp$prob_dest
  df_tmp$jointprob_pub <- df_tmp$prob_pub * df_tmp$prob_dest
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)
```


```{r}
df %>% select(starts_with("jointprob")) %>% sum()
```

```{r}
df$marketshare_walk <- df$jointprob_walk * df$PopResi*0.5
df$marketshare_bike <- df$jointprob_bike * df$PopResi*0.5
df$marketshare_car <- df$jointprob_car * df$PopResi*0.5
df$marketshare_carp <- df$jointprob_carp * df$PopResi*0.5
df$marketshare_pub <- df$jointprob_pub * df$PopResi*0.5
```

```{r}
df %>% select(starts_with("marketshare")) %>% sum()
```
```{r}
(sum(df$PopDest)/20)*0.5
```


```{r}
barplot(height=c(sum(df$marketshare_walk), sum(df$marketshare_bike), sum(df$marketshare_car), sum(df$marketshare_carp), sum(df$marketshare_pub)), names=c("walk", "bike", "car", "carp", "pub"), col="lightslateblue")
```


Exercise 2, task 1

```{r}
df$pc_new <- 10

df$v_walk <- 1.49936144786925 - 0.12*60*(df$Dist/6) #6km/h 
df$v_bike <- 2.00813319212073 - 0.12*60*(df$Dist/12) #12km/h
df$v_car <- 0.493233143126145 - 0.05*df$cc - 0.06*df$ct + 1*df$CarStat
df$v_carp <- -0.684616198063556 - 0.1*df$ct
df$v_pub <- 0.220200561302239 - 0.05*df$pc_new - 0.05*df$pt - 0.03*df$ae

datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  logsum_mode <- log(exp(df_tmp$v_walk) + exp(df_tmp$v_bike) + exp(df_tmp$v_car) + exp(df_tmp$v_carp) + exp(df_tmp$v_pub))
  df_tmp$prob_walk <- exp(df_tmp$v_walk) / exp(logsum_mode)
  df_tmp$prob_bike <- exp(df_tmp$v_bike) / exp(logsum_mode)
  df_tmp$prob_car <- exp(df_tmp$v_car) / exp(logsum_mode)
  df_tmp$prob_carp <- exp(df_tmp$v_carp) / exp(logsum_mode)
  df_tmp$prob_pub <- exp(df_tmp$v_pub) / exp(logsum_mode)
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)

df$v_dest <- 1*log(df$EmpDest + 0.15*df$PopDest)

datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  logsum_mode <- log(exp(df_tmp$v_walk) + exp(df_tmp$v_bike) + exp(df_tmp$v_car) + exp(df_tmp$v_carp) + exp(df_tmp$v_pub))
  df_tmp$prob_dest <- exp(df_tmp$v_dest + 0.7*logsum_mode) / sum(exp(df_tmp$v_dest + 0.7*logsum_mode))
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)

datalist = list()
for (i in unique(df$ResiZone)){
  df_tmp <- filter(df,ResiZone == i)
  df_tmp$jointprob_walk <- df_tmp$prob_walk * df_tmp$prob_dest 
  df_tmp$jointprob_bike <- df_tmp$prob_bike * df_tmp$prob_dest 
  df_tmp$jointprob_car <- df_tmp$prob_car * df_tmp$prob_dest 
  df_tmp$jointprob_carp <- df_tmp$prob_carp * df_tmp$prob_dest
  df_tmp$jointprob_pub <- df_tmp$prob_pub * df_tmp$prob_dest
  datalist[[i]] <- df_tmp
}
df <- do.call(rbind, datalist)

df$marketshare_walk_sc <- df$jointprob_walk * df$PopResi*0.5
df$marketshare_bike_sc <- df$jointprob_bike * df$PopResi*0.5
df$marketshare_car_sc <- df$jointprob_car * df$PopResi*0.5
df$marketshare_carp_sc <- df$jointprob_carp * df$PopResi*0.5
df$marketshare_pub_sc <- df$jointprob_pub * df$PopResi*0.5

```

```{r}
barplot(height=c(sum(df$marketshare_walk_sc), sum(df$marketshare_bike_sc), sum(df$marketshare_car_sc), sum(df$marketshare_carp_sc), sum(df$marketshare_pub_sc)), names=c("walk", "bike", "car", "carp", "pub"), col="cyan")
```
```{r}
relchange_walk <- sum(df$marketshare_walk_sc) / sum(df$marketshare_walk)
relchange_bike <- sum(df$marketshare_bike_sc) / sum(df$marketshare_bike)
relchange_car <- sum(df$marketshare_car_sc) / sum(df$marketshare_car)
relchange_carp <- sum(df$marketshare_carp_sc) / sum(df$marketshare_carp)
relchange_pub <- sum(df$marketshare_pub_sc) / sum(df$marketshare_pub)
```

```{r}
od$trip_w_sc <- od$trip_w * relchange_walk
od$trip_b_sc <- od$trip_b * relchange_bike
od$trip_c_sc <- od$trip_c * relchange_car
od$trip_cp_sc <- od$trip_cp * relchange_carp
od$trip_p_sc <- od$trip_p * relchange_pub
```

We have more trips in the given OD matrix
```{r}
sum(od$trip_w + od$trip_b + od$trip_c + od$trip_cp + od$trip_p)*0.5
sum(od$trip_w_sc + od$trip_b_sc + od$trip_c_sc + od$trip_cp_sc + od$trip_p_sc)*0.5

```


```{r}
barplot(height=c(sum(od$trip_w_sc)*0.5, sum(od$trip_b_sc)*0.5, sum(od$trip_c_sc)*0.5, sum(od$trip_cp_sc)*0.5, sum(od$trip_p_sc)*0.5), names=c("walk", "bike", "car", "carp", "pub"), col="red")
```
```{r}
sum(c(sum(od$trip_w_sc)*0.5, sum(od$trip_b_sc)*0.5, sum(od$trip_c_sc)*0.5, sum(od$trip_cp_sc)*0.5, sum(od$trip_p_sc)*0.5))
```
```{r}
SVTT <- 70
GTC_pub_0 <- df$pc + SVTT*(df$pt/60) + 1.5*SVTT*(df$ae/60)
GTC_pub_1 <- df$pc_new + SVTT*(df$pt/60) + 1.5*SVTT*(df$ae/60)
consumer_surplus_pub <- 0.5*(od$trip_p + od$trip_p_sc)*(GTC_pub_0 - GTC_pub_1)

ticket_revenue_base <- df$pc * od$trip_p
ticket_revenue_sc <- 10 * od$trip_p_sc

barplot(height=c(sum(consumer_surplus_pub), sum(ticket_revenue_base - ticket_revenue_sc)), names=c("consumer surplus", "lost ticket revenue"), col="grey")

```
```{r}
sum(consumer_surplus_pub) - sum(ticket_revenue_base - ticket_revenue_sc)
```

